{% extends "admin/layout.html" %}
{% set title = user.username %}
{% set active_page = "users" %}

{% block body %}
<main class="min-h-screen py-12 px-4">
  <div class="max-w-4xl mx-auto">
    <!-- Page Header -->
    <div class="flex justify-between items-start mb-8">
      <div class="flex items-center gap-4">
        <div class="avatar placeholder">
          <div class="bg-primary text-primary-content w-16 rounded-xl">
            <span class="text-2xl">{{user.first_name[0]|upper}}{{user.last_name[0]|upper}}</span>
          </div>
        </div>
        <div>
          <h1 class="text-3xl font-bold text-base-content">{{user.username}}</h1>
          <p class="mt-1 text-base-content/60">{{user.first_name}} {{user.last_name}}</p>
        </div>
      </div>
      <div class="flex gap-2">
        <a href="/dashboard/users/{{user.id_str}}/edit" class="btn btn-outline gap-2">
          <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
          </svg>
          Edit
        </a>
      </div>
    </div>

    {% include "errors.html" %}

    <!-- Success/Error Messages from Query Params -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const params = new URLSearchParams(window.location.search);
        const success = params.get('success');
        const error = params.get('error');
        if (success) {
          const alert = document.createElement('div');
          alert.className = 'alert alert-success mb-4';
          alert.innerHTML = '<span>' + decodeURIComponent(success.replace(/\+/g, ' ')) + '</span>';
          document.querySelector('main .max-w-4xl').insertBefore(alert, document.querySelector('main .max-w-4xl').children[1]);
        }
        if (error) {
          const alert = document.createElement('div');
          alert.className = 'alert alert-error mb-4';
          alert.innerHTML = '<span>' + decodeURIComponent(error.replace(/\+/g, ' ')) + '</span>';
          document.querySelector('main .max-w-4xl').insertBefore(alert, document.querySelector('main .max-w-4xl').children[1]);
        }
      });
    </script>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Profile Card -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title text-lg mb-4">Profile Information</h2>

          <div class="space-y-4">
            <div class="flex justify-between">
              <span class="text-base-content/60">Email</span>
              <div class="flex items-center gap-2">
                <span>{{user.email}}</span>
                {% if user.email_verified %}
                <span class="badge badge-success badge-sm">Verified</span>
                {% else %}
                <span class="badge badge-warning badge-sm">Unverified</span>
                {% endif %}
              </div>
            </div>

            <div class="flex justify-between">
              <span class="text-base-content/60">First Name</span>
              <span>{{user.first_name}}</span>
            </div>

            <div class="flex justify-between">
              <span class="text-base-content/60">Last Name</span>
              <span>{{user.last_name}}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Role & Status Card -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title text-lg mb-4">Role & Status</h2>

          <div class="space-y-4">
            <div class="flex justify-between items-center">
              <span class="text-base-content/60">Role</span>
              <span class="badge {% if user.role == 'admin' %}badge-primary{% else %}badge-ghost{% endif %} badge-lg">
                {{user.role}}
              </span>
            </div>

            <div class="flex justify-between items-center">
              <span class="text-base-content/60">Status</span>
              {% if user.locked_at %}
              <span class="badge badge-error badge-lg gap-1">
                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                </svg>
                Locked
              </span>
              {% else %}
              <span class="badge badge-success badge-lg">Active</span>
              {% endif %}
            </div>

            {% if user.locked_at %}
            <div class="flex justify-between">
              <span class="text-base-content/60">Lock Reason</span>
              <span class="text-sm">{{user.lock_reason}}</span>
            </div>

            <div class="flex justify-between">
              <span class="text-base-content/60">Locked At</span>
              <span class="text-sm">{{user.locked_at|date('%Y-%m-%d %H:%M')}}</span>
            </div>
            {% endif %}

            <div class="flex justify-between">
              <span class="text-base-content/60">Failed Login Attempts</span>
              <span class="{% if user.failed_login_attempts > 0 %}text-warning{% endif %}">
                {{user.failed_login_attempts}}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Scopes Card -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title text-lg mb-4">Scopes</h2>

          {% if user.scope %}
          <div class="flex flex-wrap gap-2">
            {% for scope in user.scopes_list %}
            <span class="badge badge-outline">{{scope}}</span>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-base-content/40 italic">No scopes assigned</p>
          {% endif %}
        </div>
      </div>

      <!-- Activity Card -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title text-lg mb-4">Activity</h2>

          <div class="space-y-4">
            <div class="flex justify-between">
              <span class="text-base-content/60">Last Login</span>
              {% if user.last_login_at %}
              <span>{{user.last_login_at|date('%Y-%m-%d %H:%M')}}</span>
              {% else %}
              <span class="text-base-content/40">Never</span>
              {% endif %}
            </div>

            <div class="flex justify-between">
              <span class="text-base-content/60">Last Login IP</span>
              {% if user.last_login_ip %}
              <code class="text-sm">{{user.last_login_ip}}</code>
              {% else %}
              <span class="text-base-content/40">-</span>
              {% endif %}
            </div>

            <div class="flex justify-between">
              <span class="text-base-content/60">Created</span>
              <span>{{user.created_at|date('%Y-%m-%d %H:%M')}}</span>
            </div>

            <div class="flex justify-between">
              <span class="text-base-content/60">Updated</span>
              <span>{{user.updated_at|date('%Y-%m-%d %H:%M')}}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Active Sessions Card -->
    <div class="card bg-base-100 shadow-xl mt-6">
      <div class="card-body">
        <div class="flex justify-between items-center mb-4">
          <h2 class="card-title text-lg">Active Sessions</h2>
          {% if sessions|length > 0 %}
          <form action="/dashboard/users/{{user.id_str}}/sessions/revoke-all" method="POST"
                onsubmit="return confirm('Are you sure you want to sign out all sessions for this user?')">
            <button type="submit" class="btn btn-sm btn-outline btn-error gap-1">
              <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
              </svg>
              Sign Out All
            </button>
          </form>
          {% endif %}
        </div>

        {% if sessions|length > 0 %}
        <div class="overflow-x-auto">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Device</th>
                <th>IP Address</th>
                <th>Last Activity</th>
                <th class="text-right">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for session in sessions %}
              <tr class="hover">
                <td>
                  <div class="flex items-center gap-2">
                    <svg class="h-5 w-5 text-base-content/60" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 01-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0115 18.257V17.25m6-12V15a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 15V5.25m18 0A2.25 2.25 0 0018.75 3H5.25A2.25 2.25 0 003 5.25m18 0V12a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 12V5.25" />
                    </svg>
                    <span class="text-sm">{{session.device_info}}</span>
                  </div>
                </td>
                <td>
                  <code class="text-xs">{{session.ip_address}}</code>
                </td>
                <td>
                  <span class="text-sm text-base-content/60">{{session.last_activity_relative}}</span>
                </td>
                <td class="text-right">
                  <form action="/dashboard/users/{{user.id_str}}/sessions/{{session.id_str}}/revoke" method="POST" class="inline">
                    <button type="submit" class="btn btn-ghost btn-xs text-error" title="Revoke Session">
                      <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="text-base-content/40 italic">No active sessions</p>
        {% endif %}
      </div>
    </div>

    <!-- Actions Card -->
    <div class="card bg-base-100 shadow-xl mt-6">
      <div class="card-body">
        <h2 class="card-title text-lg mb-4">Account Actions</h2>

        <div class="flex flex-wrap gap-4">
          <!-- Lock/Unlock -->
          {% if user.locked_at %}
          <form action="/dashboard/users/{{user.id_str}}/unlock" method="POST" class="inline">
            <button type="submit" class="btn btn-success gap-2">
              <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5V6.75a4.5 4.5 0 119 0v3.75M3.75 21.75h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H3.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
              </svg>
              Unlock Account
            </button>
          </form>
          {% else %}
          <button onclick="document.getElementById('lock_modal').showModal()" class="btn btn-warning gap-2">
            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
            </svg>
            Lock Account
          </button>
          {% endif %}

          <!-- Reset Password -->
          <button onclick="document.getElementById('password_modal').showModal()" class="btn btn-outline gap-2">
            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z" />
            </svg>
            Reset Password
          </button>
        </div>
      </div>
    </div>

    <!-- Danger Zone -->
    <div class="card bg-base-100 shadow-xl border-2 border-error/30 mt-6">
      <div class="card-body">
        <h2 class="card-title text-lg text-error mb-4">Danger Zone</h2>

        <div class="flex items-center justify-between">
          <div>
            <h3 class="font-medium">Delete this user</h3>
            <p class="text-sm text-base-content/60">
              Once deleted, all associated tokens, consents, and data will be removed. This action cannot be undone.
            </p>
          </div>
          <form action="/dashboard/users/{{user.id_str}}/delete" method="POST"
                onsubmit="return confirm('Are you sure you want to delete this user? This action cannot be undone.')">
            <button type="submit" class="btn btn-error btn-outline">Delete User</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Back Link -->
    <div class="mt-6">
      <a href="/dashboard/users" class="btn btn-ghost gap-2">
        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
        </svg>
        Back to Users
      </a>
    </div>
  </div>

  <!-- Lock Modal -->
  <dialog id="lock_modal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg">Lock User Account</h3>
      <p class="py-4">This will lock the account and invalidate all active sessions.</p>
      <form action="/dashboard/users/{{user.id_str}}/lock" method="POST">
        <div class="form-control">
          <label class="label">
            <span class="label-text">Lock Reason</span>
          </label>
          <input type="text" name="reason" class="input input-bordered" placeholder="Enter reason for locking..." required />
        </div>
        <div class="modal-action">
          <button type="button" class="btn" onclick="document.getElementById('lock_modal').close()">Cancel</button>
          <button type="submit" class="btn btn-warning">Lock Account</button>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!-- Password Reset Modal -->
  <dialog id="password_modal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg">Reset Password</h3>
      <p class="py-4">Set a temporary password for this user.</p>
      <form action="/dashboard/users/{{user.id_str}}/reset-password" method="POST">
        <div class="form-control">
          <label class="label">
            <span class="label-text">New Password</span>
          </label>
          <input type="password" name="password" class="input input-bordered" placeholder="Enter new password..." required minlength="8" />
          <label class="label">
            <span class="label-text-alt">Minimum 8 characters</span>
          </label>
        </div>
        <div class="modal-action">
          <button type="button" class="btn" onclick="document.getElementById('password_modal').close()">Cancel</button>
          <button type="submit" class="btn btn-primary">Set Password</button>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>
</main>
{% endblock %}
