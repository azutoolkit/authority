{% extends "admin/layout.html" %}
{% set title = "Manage Users" %}
{% set active_page = "users" %}

{% block body %}
<main class="min-h-screen py-12 px-4">
    <!-- Page Header -->
    <div class="flex justify-between items-center mb-8">
      <div>
        <h1 class="text-3xl font-bold text-base-content">Users</h1>
        <p class="mt-2 text-base-content/60">Manage user accounts and permissions</p>
      </div>
      <div class="flex gap-2">
        <a href="/dashboard/users/export?search={{search}}&status={{status}}&role={{role}}" class="btn btn-outline gap-2">
          <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
          </svg>
          Export CSV
        </a>
        <a href="/dashboard/users/new" class="btn btn-primary gap-2">
          <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
          </svg>
          New User
        </a>
      </div>
    </div>

    {% include "errors.html" %}

    <!-- Success/Error Messages from Query Params -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const params = new URLSearchParams(window.location.search);
        const success = params.get('success');
        const error = params.get('error');
        if (success) {
          const alert = document.createElement('div');
          alert.className = 'alert alert-success mb-4';
          alert.innerHTML = '<span>' + decodeURIComponent(success.replace(/\+/g, ' ')) + '</span>';
          document.querySelector('main').insertBefore(alert, document.querySelector('main').children[1]);
        }
        if (error) {
          const alert = document.createElement('div');
          alert.className = 'alert alert-error mb-4';
          alert.innerHTML = '<span>' + decodeURIComponent(error.replace(/\+/g, ' ')) + '</span>';
          document.querySelector('main').insertBefore(alert, document.querySelector('main').children[1]);
        }
      });
    </script>

    <!-- Filters -->
    <div class="card bg-base-100 shadow-xl mb-6">
      <div class="card-body p-4">
        <form action="/dashboard/users" method="GET" class="flex flex-wrap gap-4 items-end">
          <div class="form-control flex-1 min-w-[200px]">
            <label class="label">
              <span class="label-text">Search</span>
            </label>
            <input type="text" name="search" value="{{search}}" placeholder="Username, email, or name..."
                   class="input input-bordered input-sm w-full" />
          </div>
          <div class="form-control w-32">
            <label class="label">
              <span class="label-text">Status</span>
            </label>
            <select name="status" class="select select-bordered select-sm w-full">
              <option value="">All</option>
              <option value="active" {% if status == 'active' %}selected{% endif %}>Active</option>
              <option value="locked" {% if status == 'locked' %}selected{% endif %}>Locked</option>
            </select>
          </div>
          <div class="form-control w-32">
            <label class="label">
              <span class="label-text">Role</span>
            </label>
            <select name="role" class="select select-bordered select-sm w-full">
              <option value="">All</option>
              <option value="user" {% if role == 'user' %}selected{% endif %}>User</option>
              <option value="admin" {% if role == 'admin' %}selected{% endif %}>Admin</option>
            </select>
          </div>
          <button type="submit" class="btn btn-sm btn-primary">Filter</button>
          <a href="/dashboard/users" class="btn btn-sm btn-ghost">Clear</a>
        </form>
      </div>
    </div>

    <!-- Users Table with Bulk Operations -->
    <form id="bulkForm" action="/dashboard/users/bulk" method="POST">
      <!-- Bulk Actions Bar -->
      <div id="bulkActionsBar" class="hidden card bg-base-200 shadow mb-4">
        <div class="card-body p-3 flex flex-row items-center justify-between">
          <div class="flex items-center gap-3">
            <span class="text-sm font-medium"><span id="selectedCount">0</span> users selected</span>
          </div>
          <div class="flex items-center gap-2">
            <input type="hidden" name="action" id="bulkAction" value="">
            <button type="button" onclick="executeBulkAction('lock')" class="btn btn-sm btn-warning gap-1">
              <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
              </svg>
              Lock
            </button>
            <button type="button" onclick="executeBulkAction('unlock')" class="btn btn-sm btn-success gap-1">
              <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5V6.75a4.5 4.5 0 119 0v3.75M3.75 21.75h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H3.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
              </svg>
              Unlock
            </button>
            <button type="button" onclick="executeBulkAction('export')" class="btn btn-sm btn-info gap-1">
              <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
              </svg>
              Export
            </button>
            <button type="button" onclick="confirmBulkDelete()" class="btn btn-sm btn-error gap-1">
              <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
              </svg>
              Delete
            </button>
            <button type="button" onclick="clearSelection()" class="btn btn-sm btn-ghost">Cancel</button>
          </div>
        </div>
      </div>

      <div class="card bg-base-100 shadow-xl">
        <div class="card-body p-0">
          {% if users|length > 0 %}
          <div class="overflow-x-auto">
            <table class="table table-zebra">
              <thead>
                <tr class="bg-base-200">
                  <th class="w-12">
                    <label>
                      <input type="checkbox" class="checkbox checkbox-sm" id="selectAll" onchange="toggleSelectAll(this)">
                    </label>
                  </th>
                  <th>User</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Status</th>
                  <th>Last Login</th>
                  <th>Created</th>
                  <th class="text-right">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for user in users %}
                <tr class="hover">
                  <td>
                    <label>
                      <input type="checkbox" class="checkbox checkbox-sm user-checkbox" name="ids[]" value="{{user.id_str}}" onchange="updateBulkUI()">
                    </label>
                  </td>
                  <td>
                    <div class="flex items-center gap-3">
                      <div class="avatar placeholder">
                        <div class="bg-neutral text-neutral-content w-10 rounded-full">
                          <span class="text-lg">{{user.first_name[0]|upper}}{{user.last_name[0]|upper}}</span>
                        </div>
                      </div>
                      <div>
                        <div class="font-bold">{{user.username}}</div>
                        <div class="text-sm text-base-content/60">{{user.first_name}} {{user.last_name}}</div>
                      </div>
                    </div>
                  </td>
                  <td>
                    <span class="text-sm">{{user.email}}</span>
                    {% if user.email_verified %}
                    <span class="badge badge-success badge-xs ml-1" title="Verified">âœ“</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge {% if user.role == 'admin' %}badge-primary{% else %}badge-ghost{% endif %}">
                      {{user.role}}
                    </span>
                  </td>
                  <td>
                    {% if user.locked_at %}
                    <span class="badge badge-error gap-1">
                      <svg class="h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                      </svg>
                      Locked
                    </span>
                    {% else %}
                    <span class="badge badge-success">Active</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if user.last_login_at %}
                    <span class="text-sm text-base-content/60">{{user.last_login_at|date('%Y-%m-%d %H:%M')}}</span>
                    {% else %}
                    <span class="text-sm text-base-content/40">Never</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="text-sm text-base-content/60">{{user.created_at|date('%Y-%m-%d')}}</span>
                  </td>
                  <td class="text-right">
                    <div class="flex justify-end gap-1">
                      <a href="/dashboard/users/{{user.id_str}}" class="btn btn-ghost btn-sm" title="View Details">
                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.64 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.64 0-8.573-3.007-9.963-7.178z" />
                          <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                      </a>
                      <a href="/dashboard/users/{{user.id_str}}/edit" class="btn btn-ghost btn-sm" title="Edit">
                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
                        </svg>
                      </a>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          {% if total_pages > 1 %}
          <div class="flex justify-center p-4 border-t border-base-200">
            <div class="join">
              {% if page > 1 %}
              <a href="/dashboard/users?page={{page - 1}}&search={{search}}&status={{status}}&role={{role}}" class="join-item btn btn-sm">Previous</a>
              {% endif %}
              <span class="join-item btn btn-sm btn-disabled">Page {{page}} of {{total_pages}}</span>
              {% if page < total_pages %}
              <a href="/dashboard/users?page={{page + 1}}&search={{search}}&status={{status}}&role={{role}}" class="join-item btn btn-sm">Next</a>
              {% endif %}
            </div>
          </div>
          {% endif %}

          {% else %}
          <!-- Empty State -->
          <div class="flex flex-col items-center justify-center py-16 px-4">
            <div class="avatar placeholder mb-4">
              <div class="bg-base-200 text-base-content w-16 rounded-full">
                <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
                </svg>
              </div>
            </div>
            <h3 class="text-lg font-semibold mb-2">No users found</h3>
            <p class="text-base-content/60 text-center mb-6 max-w-sm">
              {% if search or status or role %}
              No users match your filter criteria. Try adjusting your filters.
              {% else %}
              Create your first user to get started.
              {% endif %}
            </p>
            {% if not search and not status and not role %}
            <a href="/dashboard/users/new" class="btn btn-primary">Create First User</a>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>
    </form>

    <!-- Delete Confirmation Modal -->
    <dialog id="deleteModal" class="modal">
      <div class="modal-box">
        <h3 class="font-bold text-lg text-error">Confirm Bulk Delete</h3>
        <p class="py-4">Are you sure you want to delete <span id="deleteCount" class="font-bold">0</span> users? This action cannot be undone.</p>
        <div class="modal-action">
          <button type="button" class="btn" onclick="deleteModal.close()">Cancel</button>
          <button type="button" class="btn btn-error" onclick="executeBulkAction('delete')">Delete Users</button>
        </div>
      </div>
      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </dialog>

    <!-- Lock Reason Modal -->
    <dialog id="lockModal" class="modal">
      <div class="modal-box">
        <h3 class="font-bold text-lg">Lock Users</h3>
        <p class="py-2">Provide a reason for locking <span id="lockCount" class="font-bold">0</span> users:</p>
        <input type="text" id="lockReason" name="reason" class="input input-bordered w-full" placeholder="Reason for locking (optional)">
        <div class="modal-action">
          <button type="button" class="btn" onclick="lockModal.close()">Cancel</button>
          <button type="button" class="btn btn-warning" onclick="submitLock()">Lock Users</button>
        </div>
      </div>
      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </dialog>

    <!-- Back to Dashboard -->
    <div class="mt-6">
      <a href="/dashboard" class="btn btn-ghost gap-2">
        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
        </svg>
        Back to Dashboard
      </a>
    </div>
</main>

<script>
  function updateBulkUI() {
    const checkboxes = document.querySelectorAll('.user-checkbox:checked');
    const count = checkboxes.length;
    const bar = document.getElementById('bulkActionsBar');
    const countSpan = document.getElementById('selectedCount');

    countSpan.textContent = count;

    if (count > 0) {
      bar.classList.remove('hidden');
    } else {
      bar.classList.add('hidden');
    }

    // Update select all checkbox state
    const allCheckboxes = document.querySelectorAll('.user-checkbox');
    const selectAll = document.getElementById('selectAll');
    selectAll.checked = count === allCheckboxes.length && count > 0;
    selectAll.indeterminate = count > 0 && count < allCheckboxes.length;
  }

  function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.user-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
    updateBulkUI();
  }

  function clearSelection() {
    const checkboxes = document.querySelectorAll('.user-checkbox');
    checkboxes.forEach(cb => cb.checked = false);
    document.getElementById('selectAll').checked = false;
    updateBulkUI();
  }

  function executeBulkAction(action) {
    if (action === 'lock') {
      lockModal.close();
      const reason = document.getElementById('lockReason').value;
      // Add reason to form
      let reasonInput = document.querySelector('input[name="reason"]');
      if (!reasonInput) {
        reasonInput = document.createElement('input');
        reasonInput.type = 'hidden';
        reasonInput.name = 'reason';
        document.getElementById('bulkForm').appendChild(reasonInput);
      }
      reasonInput.value = reason;
    }

    if (action === 'delete') {
      deleteModal.close();
    }

    document.getElementById('bulkAction').value = action;
    document.getElementById('bulkForm').submit();
  }

  function confirmBulkDelete() {
    const count = document.querySelectorAll('.user-checkbox:checked').length;
    document.getElementById('deleteCount').textContent = count;
    deleteModal.showModal();
  }

  function showLockModal() {
    const count = document.querySelectorAll('.user-checkbox:checked').length;
    document.getElementById('lockCount').textContent = count;
    document.getElementById('lockReason').value = '';
    lockModal.showModal();
  }

  function submitLock() {
    executeBulkAction('lock');
  }

  // Override lock button to show modal
  document.addEventListener('DOMContentLoaded', function() {
    const lockBtn = document.querySelector('button[onclick="executeBulkAction(\'lock\')"]');
    if (lockBtn) {
      lockBtn.onclick = showLockModal;
    }
  });
</script>
{% endblock %}
